using System;
using System.Data;
using System.IO;
using Oracle.ManagedDataAccess.Client; // Make sure Oracle.ManagedDataAccess.Core is installed
using LibVLCSharp.Shared;

namespace VideoPlayer
{
    public partial class Form1 : Form
    {
        private LibVLC _libVLC;
        private MediaPlayer _mediaPlayer;
        private bool isMediaSet = false; // Track whether the media has already been set

        public Form1()
        {
            InitializeComponent();

            // Initialize VLC libraries
            Core.Initialize();

            // Create a new LibVLC instance
            _libVLC = new LibVLC();

            // Create a new media player using the VLC instance and assign the video view
            _mediaPlayer = new MediaPlayer(_libVLC);

            // Connect media player to videoView1
            _mediaPlayer.Hwnd = videoView1.Handle;
        }

private void playButton_Click(object sender, EventArgs e)
        {
            // Connect to the Oracle database and retrieve the video BLOB
            byte[] videoBlob = GetVideoBlobFromOracle();

            if (videoBlob != null)
            {
                // Create a MemoryStream from the byte array
                using (MemoryStream stream = new MemoryStream(videoBlob))
                {
                    // Create a custom media input for VLC to stream from memory
                    var media = new Media(_libVLC, new StreamMediaInput(stream));

                    // Set the media to the player and play
                    _mediaPlayer.Media = media;
                    _mediaPlayer.Play();
                }
            }
            else
            {
                MessageBox.Show("Failed to load video from database.");
            }
        }

        private byte[] GetVideoBlobFromOracle()
        {
            // Connection string parameters
            string connectionString = "User Id=Kingdom_Rush;Password=1234;Data Source=(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(PROTOCOL=TCP)(HOST=localhost)(PORT=1521)))(CONNECT_DATA=(SERVICE_NAME=Kingdom_Rush.localdomain)));";

            // SQL query to retrieve the BLOB from the "beat_the_level" table
            string query = "SELECT VIDEO FROM beat_the_level WHERE BEAT_THE_LEVEL_ID = :id";

            byte[] videoBlob = null;

            using (OracleConnection conn = new OracleConnection(connectionString))
            {
                conn.Open();

                using (OracleCommand cmd = new OracleCommand(query, conn))
                {
                    // Set the BEAT_THE_LEVEL_ID parameter (adjust ID as needed)
                    cmd.Parameters.Add(new OracleParameter("id", OracleDbType.Raw)).Value = /* Set the correct value for the ID */;

                    // Execute the query
                    using (OracleDataReader reader = cmd.ExecuteReader(CommandBehavior.SequentialAccess))
                    {
                        if (reader.Read())
                        {
                            // Get the BLOB as a byte array
                            using (MemoryStream ms = new MemoryStream())
                            {
                                long bufferSize = reader.GetBytes(0, 0, null, 0, 0); // Get BLOB length
                                byte[] buffer = new byte[bufferSize];
                                reader.GetBytes(0, 0, buffer, 0, (int)bufferSize);
                                ms.Write(buffer, 0, buffer.Length);
                                videoBlob = ms.ToArray();
                            }
                        }
                    }
                }
            }

            return videoBlob;
        }

        private void pauseButton_Click(object sender, EventArgs e)
        {
            if (_mediaPlayer.IsPlaying)
            {
                _mediaPlayer.Pause();
            }
        }
    }
}